<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
        <!ENTITY name      "appdata.backup">
        <!ENTITY author    "Robin Kluth">
        <!ENTITY version   "2023.04.11">
        <!ENTITY sha256    "5bcb08849e53271f004d959c347f006c43cc272657ba44bbcee5b368f443032a">
        <!ENTITY launch    "Settings/AB.Main">
        <!ENTITY plugdir   "/usr/local/emhttp/plugins/&name;">
        <!ENTITY github    "Commifreak/unraid-appdata.backup">
        <!ENTITY pluginURL "https://raw.githubusercontent.com/&github;/master/&name;.plg">
        ]>

<PLUGIN name="&name;" author="&author;" version="&version;" launch="&launch;" pluginURL="&pluginURL;" icon="shield"
        min="6.12" support="https://forums.unraid.net/topic/137710-plugin-appdatabackup/">

    <CHANGES>
        <![CDATA[
        ðŸ”§New  ðŸ©¹Fix ðŸ”§Change
###2023.04.11
- ðŸ©¹ Saving the settings with no docker containers yet, results in a blank page

###2023.04.10
- ðŸš€ First stable version!

###2023.04.03b1
- ðŸ©¹ Fixed file selector for dark themes _(Unraids global config variable handling needs a revamp...)_

### 2023.03.31b2
- ðŸ©¹ ca.backup2 migration: Migrate old source path as well

### 2023.03.31b1
- ðŸ”¨ The restore default source path defaults now to the current set destination path
- ðŸ”§ You can choose a custom restore path now. This could be useful for advanced restoring. **This only applies to extracted archives, not for the config/xmls!**
- ðŸ”§ Changed the internal/external volume mapping detection again: You can choose ALL of your valid appdata sources now. **Open help for `Appdata source(s)` for further explanation**

### 2023.03.30b1
- ðŸ”¨ If a `ca.backup2` config file is detected, the plugin now offers a config migration
- ðŸ”§ Changed the way "internal" volumes are detected: `/mnt/{user,cache}/appdata` and optionally the docker set folder are treated as such. Any other volume mapping (`/mnt/user/downloads/myDownloads` as example) is "external". You can optionally backup those too (disabled by default)

### 2023.03.29b2
- ðŸ©¹ "External" volumes (volumes not within your appdata) path are now being ignored. A future update will bring options to save them as well
- ðŸ©¹ Container exclude list was not working as expected
- ðŸ©¹ Fixed settings page issues for Safari users
- ðŸ©¹ Fixed an issue during applying default settings to containers
- ðŸ”§ Faild backups are now kept (with -failed suffix)
- ðŸ”§ `Abort` now instantly stops any running command instead of waiting for its completion

### 2023.03.28b3
- ðŸ©¹ Some file selectors are opening some others - fixed
- ðŸ”§ Display container volumes one per line

### 2023.03.28b2
- ðŸ©¹ Fixed per container (only new ones) settings being hard-set to the global defaults instead of keeping 'Use default'
- ðŸ”¨ Added back update notice banner

### 2023.03.28b1
- ðŸ”¨ Added back VM meta backup
- ðŸ”¨ Added back update notice banner

### 2023.03.27b1
- ðŸ”¨ 1st beta
]]>
    </CHANGES>


    <FILE Run="/bin/bash">
        <INLINE>
            echo "Checking some pre-install things..."
            rm $(ls /boot/config/plugins/&name;/*.tgz 2>/dev/null | grep -v '&version;')
            if [ -d "&plugdir;" ]
            then
            echo "Removing plugin files..."
            rm -rf &plugdir;
            else
            echo "Plugin files were not present. Fresh install"
            fi
            echo "Creating plugin files directory..."
            mkdir &plugdir;
        </INLINE>
    </FILE>

    <FILE Name="/boot/config/plugins/&name;/&name;-&version;.tgz">
        <URL>https://github.com/&github;/releases/download/&version;/&name;-&version;.tgz</URL>
        <SHA256>&sha256;</SHA256>
    </FILE>

    <FILE Run="/bin/bash">
        <INLINE>
            echo "Extracting plugin files..."
            tar -C &plugdir; -xzf /boot/config/plugins/&name;/&name;-&version;.tgz 2>&amp;1
        </INLINE>
    </FILE>

    <FILE Run="/bin/bash">
        <INLINE>
            php &plugdir;/scripts/checkCron.php
        </INLINE>
    </FILE>

    <FILE Run="/bin/bash">
        <INLINE>
            echo ""
            echo "----------------------------------------------------"
            echo " &name; has been installed."
            echo " (previously known as ca.backup2)"
            echo ""
            echo " 2022-2023, Robin Kluth"
            echo " Version: &version;"
            echo "----------------------------------------------------"
            echo ""
        </INLINE>
    </FILE>

    <!--
    The 'remove' script.
    -->
    <FILE Run="/bin/bash" Method="remove">
        <INLINE>
            echo "Uninstalling... ðŸ˜­ Maybe I see you again soon. Bye!"
            php &plugdir;/scripts/checkCron.php --remove
            rm -rf &plugdir; 2>/dev/null
            rm -rf /boot/config/plugins/&name;
            echo "Uninstall done."
        </INLINE>
    </FILE>
</PLUGIN>
